# =========================
# WS helper (WAJIB dalam http context)
# =========================
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# =========================
# HTTP : redirect ke HTTPS
# =========================
server {
  listen 80;
  listen [::]:80;
  server_name hoka.jateng.tech;

  # optional untuk certbot
  location ^~ /.well-known/acme-challenge/ {
    root /home/vps/public_html;
  }

  return 301 https://$host$request_uri;
}

# =========================
# HTTPS : WS + gRPC + static
# =========================
server {
  listen 443 ssl http2 reuseport;
  listen [::]:443 ssl http2 reuseport;
  server_name hoka.jateng.tech;

  ssl_certificate     /etc/xray/xray.crt;
  ssl_certificate_key /etc/xray/xray.key;
  ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;
  ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;

  root /home/vps/public_html;
  index index.html index.htm;

  # -------------------------
  # VLESS WS (PATH "/")
  # -------------------------
  location = / {
    proxy_http_version 1.1;
    proxy_redirect off;
    proxy_buffering off;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;

    proxy_pass http://127.0.0.1:12877;
  }

  # -------------------------
  # SSH WS (PATH "/fightertunnelssh")
  # -------------------------
  location = /fightertunnelssh {
    proxy_http_version 1.1;
    proxy_redirect off;
    proxy_buffering off;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;

    proxy_pass http://127.0.0.1:700;
  }

  # -------------------------
  # VMESS / TROJAN / SS (WS)
  # -------------------------
  location = /vmess {
    proxy_http_version 1.1;
    proxy_redirect off;
    proxy_buffering off;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;

    proxy_pass http://127.0.0.1:11825;
  }

  location = /trojan-ws {
    proxy_http_version 1.1;
    proxy_redirect off;
    proxy_buffering off;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;

    proxy_pass http://127.0.0.1:23591;
  }

  location = /ss-ws {
    proxy_http_version 1.1;
    proxy_redirect off;
    proxy_buffering off;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;

    proxy_pass http://127.0.0.1:23083;
  }

  # -------------------------
  # gRPC (prefix)
  # -------------------------
  location ^~ /vless-grpc {
    grpc_set_header Host $host;
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    grpc_read_timeout 86400;
    grpc_send_timeout 86400;
    grpc_pass grpc://127.0.0.1:40568;
  }

  location ^~ /vmess-grpc {
    grpc_set_header Host $host;
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    grpc_read_timeout 86400;
    grpc_send_timeout 86400;
    grpc_pass grpc://127.0.0.1:12206;
  }

  location ^~ /trojan-grpc {
    grpc_set_header Host $host;
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    grpc_read_timeout 86400;
    grpc_send_timeout 86400;
    grpc_pass grpc://127.0.0.1:34872;
  }

  location ^~ /ss-grpc {
    grpc_set_header Host $host;
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    grpc_read_timeout 86400;
    grpc_send_timeout 86400;
    grpc_pass grpc://127.0.0.1:34834;
  }

  # -------------------------
  # Static web untuk path lain (contoh /index.html)
  # -------------------------
  location / {
    try_files $uri $uri/ =404;
  }
}
